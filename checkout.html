<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - My Two Minutes</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#f97316">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    /* Base Styles */
    html, body {
      @apply overflow-y-auto min-h-screen bg-gray-100 font-sans;
    }
    .container {
      @apply max-w-md mx-auto p-4;
    }
    /* Card Styles */
    .card {
      @apply bg-white rounded-2xl shadow-md p-6 mb-6;
    }
    /* Header */
    .header {
      @apply flex justify-between items-center p-4 bg-white shadow-md sticky top-0 z-10;
    }
    /* Input Styles */
    .input-field {
      @apply w-full px-4 py-3 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500;
    }
    .input-label {
      @apply block text-sm font-medium text-gray-700 mb-2;
    }
    /* Summary List */
    .summary-item {
      @apply flex justify-between text-sm text-gray-700 py-2 border-b border-gray-200 last:border-b-0;
    }
    /* Button */
    .btn-continue {
      @apply w-full bg-orange-500 text-white text-lg font-semibold py-4 rounded-xl mt-6 hover:bg-orange-600 transition;
    }
    /* Spinner */
    .spinner {
      @apply fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 bg-white p-6 rounded-full;
    }
    .spinner.hidden {
      @apply hidden;
    }
    .animate-spin {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Toast */
    .toast {
      @apply fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-lg z-50 opacity-0 transition-opacity;
    }
    .toast.show {
      @apply opacity-100;
    }
    /* Processing Screen */
    .processing {
      @apply fixed inset-0 bg-white flex flex-col items-center justify-center z-50;
    }
    .processing.hidden {
      @apply hidden;
    }
    /* Responsive */
    @media (min-width: 640px) {
      .container { @apply max-w-lg; }
      .card { @apply p-8; }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <button onclick="window.history.back()" class="text-gray-600 hover:text-orange-500">
      <i class="fas fa-arrow-left text-xl"></i>
    </button>
    <h1 id="storeName" class="text-lg font-bold text-gray-800">Checkout</h1>
    <span></span> <!-- Placeholder for symmetry -->
  </header>

  <!-- Spinner -->
  <div id="spinner" class="spinner hidden">
    <svg class="animate-spin h-12 w-12 text-orange-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
    </svg>
  </div>

  <!-- Processing Screen -->
  <div id="processingScreen" class="processing hidden">
    <img src="https://via.placeholder.com/150/FFFFFF/000000?text=Delivery+Illustration" alt="Processing Illustration" class="mb-6">
    <h2 class="text-xl font-semibold text-gray-800">Processing Order...</h2>
    <p class="text-sm text-gray-500 mt-2">Please wait while we process your order.</p>
  </div>

  <!-- Main Content -->
  <div class="container">
    <!-- Summary Card -->
    <div class="card">
      <h2 class="text-lg font-bold text-gray-800 mb-4">Summary</h2>
      <div id="cartItems" class="space-y-4"></div>
      <div class="summary-item">
        <span>Subtotal</span>
        <span id="subtotal" class="text-orange-500">R0.00</span>
      </div>
      <div class="summary-item">
        <span>Tax</span>
        <span id="tax" class="text-orange-500">R0.00</span>
      </div>
      <div class="summary-item">
        <span>Delivery</span>
        <span id="delivery" class="text-orange-500">R0.00</span>
      </div>
      <div class="summary-item">
        <span class="font-semibold">Total</span>
        <span id="totalAmount" class="font-semibold text-orange-500">R0.00</span>
      </div>
      <button id="applyVoucherBtn" class="text-orange-500 text-sm mt-4">Apply Voucher</button>
    </div>

    <!-- Delivery Address Card -->
    <div class="card">
      <h2 class="text-lg font-bold text-gray-800 mb-4">Deliver Address</h2>
      <div id="mapPlaceholder" class="w-full h-32 bg-gray-200 rounded-lg mb-4"></div>
      <div>
        <label for="address" class="input-label">Address</label>
        <input type="text" id="address" class="input-field" placeholder="Enter delivery address" required>
      </div>
    </div>

    <!-- Action Button -->
    <button id="continueBtn" class="btn-continue">Continue</button>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Firebase + Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getDatabase, ref, onValue, push, set } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBOyZ3As4GTuNvjemvPF_SpsC6m6vqtNhc",
      authDomain: "fire-b-a8878.firebaseapp.com",
      databaseURL: "https://fire-b-a8878.firebaseio.com",
      projectId: "fire-b-a8878",
      storageBucket: "fire-b-a8878.appspot.com",
      messagingSenderId: "658673187627",
      appId: "1:658673187627:web:6e4c29af661785f0afa36e",
      measurementId: "G-V4W97VMSKL"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    const storeName = document.getElementById('storeName');
    const cartItems = document.getElementById('cartItems');
    const subtotalEl = document.getElementById('subtotal');
    const taxEl = document.getElementById('tax');
    const deliveryEl = document.getElementById('delivery');
    const totalAmountEl = document.getElementById('totalAmount');
    const addressInput = document.getElementById('address');
    const continueBtn = document.getElementById('continueBtn');
    const spinner = document.getElementById('spinner');
    const processingScreen = document.getElementById('processingScreen');
    const toast = document.getElementById('toast');

    let userId = null;
    let cart = [];
    let storeId = null;
    let storeType = null;

    // Parse URL Parameters
    const urlParams = new URLSearchParams(window.location.search);
    storeId = urlParams.get('restaurantId') || urlParams.get('shopId');
    storeType = urlParams.get('restaurantId') ? 'restaurant' : 'shop';
    try {
      cart = JSON.parse(decodeURIComponent(urlParams.get('cart') || '[]'));
    } catch (e) {
      console.error('Error parsing cart:', e);
      showToast('Invalid cart data.');
    }

    onAuthStateChanged(auth, user => {
      spinner.classList.remove('hidden');
      if (user) {
        userId = user.uid;
        loadStoreDetails();
        renderCartItems();
        spinner.classList.add('hidden');
      } else {
        spinner.classList.add('hidden');
        window.location.href = 'login.html';
      }
    });

    function showToast(message) {
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function loadStoreDetails() {
      if (!storeId) {
        showToast('No store specified.');
        return;
      }
      const storeRef = ref(db, `${storeType}s/${storeId}`);
      onValue(storeRef, (snapshot) => {
        const store = snapshot.val();
        if (store) {
          storeName.textContent = `${store.name} - Checkout`;
        } else {
          showToast(`${storeType.charAt(0).toUpperCase() + storeType.slice(1)} not found.`);
          storeName.textContent = 'Checkout';
        }
      }, (error) => {
        console.error(`Error loading ${storeType} details:`, error);
        showToast(`Failed to load ${storeType} details.`);
      });
    }

    function renderCartItems() {
      cartItems.innerHTML = '';
      let subtotal = 0;
      if (cart.length === 0) {
        cartItems.innerHTML = '<p class="text-sm text-gray-500">Your cart is empty.</p>';
        updateSummary(0, 0, 0);
        return;
      }
      cart.forEach((item, index) => {
        const itemTotal = item.item.price * item.quantity;
        subtotal += itemTotal;
        const el = document.createElement('div');
        el.className = 'flex justify-between items-center';
        el.innerHTML = `
          <div>
            <span class="text-sm text-gray-700">${item.item.name}</span>
            <span class="text-xs text-gray-500"> x${item.quantity}</span>
          </div>
          <span class="text-sm text-orange-500">R${itemTotal.toFixed(2)}</span>
        `;
        cartItems.appendChild(el);
      });
      const tax = subtotal * 0.05; // 5% tax as an example
      const delivery = 10.00; // Fixed delivery fee as an example
      updateSummary(subtotal, tax, delivery);
    }

    function updateSummary(subtotal, tax, delivery) {
      subtotalEl.textContent = `R${subtotal.toFixed(2)}`;
      taxEl.textContent = `R${tax.toFixed(2)}`;
      deliveryEl.textContent = `R${delivery.toFixed(2)}`;
      totalAmountEl.textContent = `R${(subtotal + tax + delivery).toFixed(2)}`;
    }

    continueBtn.addEventListener('click', () => {
      if (!addressInput.value.trim()) {
        showToast('Please enter a delivery address.');
        return;
      }
      spinner.classList.remove('hidden');
      setTimeout(() => {
        spinner.classList.add('hidden');
        processingScreen.classList.remove('hidden');
        setTimeout(() => {
          processingScreen.classList.add('hidden');
          showToast('Order placed successfully!');
          window.location.href = `status.html?${storeType}Id=${storeId}`;
        }, 2000);
      }, 2000);
    });
  </script>
</body>
</html>
